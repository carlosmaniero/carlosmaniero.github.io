<!DOCTYPE html>
<html lang="en">
<head>
          <title>Maniero - PHP - Long Polling</title>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/theme/css/main.css" />
        <link rel="stylesheet" type="text/css" href="/theme/css/code.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Maniero Full Atom Feed" />




    <meta name="tags" content="PHP" />

</head>

<body>
        <header>
            <h1>
                <a href="/">Maniero</a>
            </h1>
                <h2>Personal blog, mostly about software engineering.</h2>
        </header>

        <div id="page-layout">
            <nav>


                    <ul aria-label="Categories">
                            <li><a href="/category/engineer-life.html">Engineer life</a></li>
                            <li class="active"><a href="/category/php.html">PHP</a></li>
                            <li><a href="/category/python.html">Python</a></li>
                    </ul>

                <ul aria-label="Links">
                    <li>
                        <a href="mailto:carlosmaniero@gmail.com">Email</a>
                        <a target="_blank" href="/feeds/all.atom.xml" type="application/atom+xml">RSS</a>
                    </li>
                </ul>

                <ul aria-label="Accessibility">
                    <li>
                        <button class="lights" href="">
                            Toggle lights
                        </button>
                    </li>
                </ul>

            </nav>

            <main>
  <header>
    <h1 class="entry-title">
      <a href="/php-long-polling.html" rel="bookmark"
         title="Permalink to PHP - Long Polling">PHP - Long Polling</a></h1>
 
  </header>
  <article>
    <p>Long Polling is a technique used when you need create a real time application,
where the server will wait from a event occur to response the request.</p>
<p>On this example, we will create a webchat, using a simple text file.
The server will read the text file,
and will hold the conection until the file has new lines.
To check it, the server will receive the current line number.</p>
<p>Go to the code</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>
<span class="c1">// Disable max runtime</span>
<span class="nb">set_time_limit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="k">function</span> <span class="nf">poll</span><span class="p">(</span><span class="nv">$cur_line</span><span class="p">){</span>    
    <span class="c1">// An infinite loop</span>
    <span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">){</span>    
        <span class="c1">// Read the file</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s1">&#39;chat.txt&#39;</span><span class="p">);</span>
        <span class="nv">$lines</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$lines</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$cur_line</span> <span class="o">||</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])){</span>
            <span class="c1">// Sleep for 1 seccond if no new line</span>
            <span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> 
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="nv">$ret</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
            <span class="nv">$ret</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
            <span class="c1">// Put new lines in the vector</span>
            <span class="k">for</span><span class="p">(</span><span class="nv">$cur_line</span><span class="p">;</span> <span class="nv">$cur_line</span> <span class="o">&lt;</span> <span class="nb">count</span><span class="p">(</span><span class="nv">$lines</span><span class="p">);</span> <span class="nv">$cur_line</span><span class="o">++</span><span class="p">){</span>
                <span class="nv">$ret</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">][]</span> <span class="o">=</span> <span class="nv">$lines</span><span class="p">[</span><span class="nv">$cur_line</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="c1">// Update the cur_line to response</span>
            <span class="nv">$ret</span><span class="p">[</span><span class="s1">&#39;cur_line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$cur_line</span><span class="p">;</span>
            <span class="c1">// Return an JSON</span>
            <span class="k">return</span> <span class="nb">json_encode</span><span class="p">(</span><span class="nv">$ret</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// echo the result</span>
<span class="k">echo</span> <span class="nx">poll</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">&#39;cur_line&#39;</span><span class="p">]);</span>
<span class="cp">?&gt;</span><span class="x"></span>
</code></pre></div>

<p>You can see the complete code <a href="https://github.com/carlosmaniero/Php-long-polling">here</a></p>
<hr>
<h4>Old Post</h4>
<p>This is an old post migrated from my old blog. 
You can see the original content <a href="http://carlosmaniero.blogspot.com.br/2012/07/php-long-polling.html">here</a>[pt-br]</p>

  <footer class="post-info">
    <div class="feedbacks">
      If you'd like to give any feedback on this article, email me at
      <a href="mailto:carlosmaniero@gmail.com">carlosmaniero@gmail.com</a>.
    </div>
    <time class="published" datetime="2012-07-18T11:25:00-03:00">
      Wed 18 July 2012
    </time>
    <div class="category">
        Category: <a href="/category/php.html">PHP</a>
    </div>
    <div class="tags">
        Tags:
            <a href="/tag/php.html">PHP</a>
    </div>
  </footer><!-- /.post-info -->
  </article>
            </main>
        </div>
        <footer>
            <address id="about" class="vcard body">
                Â© 2022 Maniero
            </address>
            This website does not use cookies.
        </footer>
        <script type="text/javascript">
         const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
         const isDarkModeEnabled = () => {
             const localValue = localStorage.getItem("dark-mode");
             if (localValue) {
                 return localValue === "true";
             }
             return !!prefersDarkMode;
         }

         const toggleDarkModeState = () => localStorage.setItem("dark-mode", !isDarkModeEnabled());

         const toggleThemeTag = () => {
             const root = document.getElementsByTagName( 'html' )[0]; // '0' to assign the first (and only `HTML` tag)
             root.setAttribute('data-dark-theme', isDarkModeEnabled());
         }

         toggleThemeTag();

         document.querySelector('.lights').addEventListener('click', () => {
             toggleDarkModeState();
             toggleThemeTag();
         });
        </script>
</body>
</html>